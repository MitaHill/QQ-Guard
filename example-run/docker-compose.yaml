services:
  base:
    image: qq-guard-base:local
    build:
      context: ..
      dockerfile: docker/base/Dockerfile
    profiles:
      - build

  app:
    image: qq-guard-app:local
    build:
      context: ..
      dockerfile: docker/app/Dockerfile
    env_file:
      - ./.env
    volumes:
      - ./db:/app/db
      - ./log:/app/log
      - ../app/config/AppConfig.Yaml:/app/config/AppConfig.Yaml
      - ../app/config/info2ai:/app/config/info2ai
    ports:
      - "${QQ_GUARD_HTTP_POST_PORT:-8080}:${QQ_GUARD_HTTP_POST_PORT:-8080}"
    restart: unless-stopped

  web:
    image: qq-guard-app:local
    build:
      context: ..
      dockerfile: docker/app/Dockerfile
    command: ["python", "-m", "src.WebUi.web_ui_app"]
    env_file:
      - ./.env
    volumes:
      - ./db:/app/db
      - ./log:/app/log
      - ../app/config/AppConfig.Yaml:/app/config/AppConfig.Yaml
      - ../app/config/info2ai:/app/config/info2ai
      - ../app/WebUI:/app/WebUI:ro
    ports:
      - "${QQ_GUARD_WEB_PORT:-5000}:${QQ_GUARD_WEB_PORT:-5000}"
    restart: unless-stopped

  web-ui:
    image: node:20-alpine
    working_dir: /web
    command: ["sh", "-c", "npm install && npm run dev"]
    environment:
      VITE_API_TARGET: http://web:5000
    volumes:
      - ../app/WebUI:/web
      - web-ui-node-modules:/web/node_modules
    ports:
      - "5173:5173"
    profiles:
      - frontend

volumes:
  web-ui-node-modules:
